name: Send Bale Notification on Commit
on:
  push:
    branches: [ main, master ]

jobs:
  send-bale-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info and changes
        id: get_info
        run: |
          python3 << 'EOF'
          import subprocess
          import re
          import json
          import os
          
          try:
              result = subprocess.run(
                  ['git', 'diff', '--name-only', os.environ['GITHUB_SHA'] + '~1', os.environ['GITHUB_SHA']],
                  capture_output=True, text=True, check=True
              )
              changed_files = [f for f in result.stdout.strip().split('\n') if f]
          except:
              changed_files = ["Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØºÛŒÛŒØ±Ø§Øª"]
          
          version = "Ù†Ø§Ù…Ø´Ø®Øµ"
          stable = "False"
          
          try:
              with open('version.py', 'r') as f:
                  content = f.read()
              
              version_match = re.search(r'version\s*=\s*["\']([^"\']+)["\']', content)
              stable_match = re.search(r'stable\s*=\s*(True|False)', content)
              
              version = version_match.group(1) if version_match else "Ù†Ø§Ù…Ø´Ø®Øµ"
              stable = stable_match.group(1) if stable_match else "False"
          except:
              pass
          
          try:
              commit_msg = subprocess.run(
                  ['git', 'log', '--format=%B', '-n', '1', os.environ['GITHUB_SHA']],
                  capture_output=True, text=True, check=True
              ).stdout.strip()
          except:
              commit_msg = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù… Ú©Ø§Ù…ÛŒØª"
          
          files_text = "\\n".join([f"â€¢ {file}" for file in changed_files]) if changed_files else "Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±Ø§Øª ÙØ§ÛŒÙ„"
          
          print(f"VERSION={version}")
          print(f"STABLE={stable}")
          print(f"CHANGED_FILES={files_text}")
          print(f"COMMIT_MSG={commit_msg}")
          EOF

      - name: Send message to Bale
        run: |
          MESSAGE='ðŸŽ‰ **Ù†Ø³Ø®Ù‡ Ø¬Ø¯ÛŒØ¯ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ù¾Ø§ÛŒØ±ÙˆØ¨Ù„Ù‡ Ù…Ù†ØªØ´Ø± Ø´Ø¯!**\n\n**ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ:**\n${{ steps.get_info.outputs.CHANGED_FILES }}\n\n**Ù¾ÛŒØ§Ù… Ú©Ø§Ù…ÛŒØª:**\n${{ steps.get_info.outputs.COMMIT_MSG }}\n\n**Ù†Ø³Ø®Ù‡ ÙØ¹Ù„ÛŒ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡:** ${{ steps.get_info.outputs.VERSION }}\n**Ù…Ù†ØªØ´Ø± Ø´Ø¯Ù‡ Ø¯Ø± pypi:** ${{ fromJSON(steps.get_info.outputs.STABLE) && 'âœ…' || 'âŒ' }}\n\n**ðŸ”— Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø± GitHub:**\n${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}\n\nðŸ†” @pyrobale'
          
          curl -X POST \
            -H "Content-Type: application/json" \
            -d "{
              \"chat_id\": \"${{ secrets.BALE_CHAT_ID }}\",
              \"text\": \"$MESSAGE\",
              \"parse_mode\": \"Markdown\"
            }" \
            "https://tapi.bale.ai/bot${{ secrets.BALE_BOT_TOKEN }}/sendMessage"