name: Send Bale Notification on Commit
on:
  push:
    branches: [ main, master ]

jobs:
  send-bale-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Get info and send to Bale
        run: |
          python3 << 'EOF'
          import requests
          import subprocess
          import re
          import os
          
          try:
              result = subprocess.run(
                  ['git', 'diff', '--name-only', os.environ['GITHUB_SHA'] + '~1', os.environ['GITHUB_SHA']],
                  capture_output=True, text=True, check=True
              )
              changed_files = [f for f in result.stdout.strip().split('\n') if f]
          except:
              changed_files = ["Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ØªØºÛŒÛŒØ±Ø§Øª"]
          
          version = "Ù†Ø§Ù…Ø´Ø®Øµ"
          stable = False
          
          try:
              with open('version.py', 'r') as f:
                  content = f.read()
              
              version_match = re.search(r'version\s*=\s*["\']([^"\']+)["\']', content)
              stable_match = re.search(r'stable\s*=\s*(True|False)', content)
              
              version = version_match.group(1) if version_match else "Ù†Ø§Ù…Ø´Ø®Øµ"
              stable = stable_match.group(1) == "True" if stable_match else False
          except Exception as e:
              print(f"Error reading version.py: {e}")
          
          try:
              commit_msg = subprocess.run(
                  ['git', 'log', '--format=%B', '-n', '1', os.environ['GITHUB_SHA']],
                  capture_output=True, text=True, check=True
              ).stdout.strip()
          except:
              commit_msg = "Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù… Ú©Ø§Ù…ÛŒØª"
          
          files_text = "\n".join([f"â€¢ {file}" for file in changed_files]) if changed_files else "Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±Ø§Øª ÙØ§ÛŒÙ„"
          pypi_status = "Ø¯Ø± pypi Ù…Ù†ØªØ´Ø± Ø´Ø¯!" if stable else "Ø§ÛŒÙ† Ù†Ø³Ø®Ù‡ Ù‡Ù†ÙˆØ² Ø¯Ø± pypi Ù…Ù†Ø´Ø± Ù†Ø´Ø¯Ù‡."
          github_url = f"{os.environ['GITHUB_SERVER_URL']}/{os.environ['GITHUB_REPOSITORY']}/commit/{os.environ['GITHUB_SHA']}"
          
          message = f"""ðŸŽ‰ *ØªØºÛŒÛŒØ±Ø§Øª Ø¬Ø¯ÛŒØ¯ÛŒ Ø¯Ø± Ù…Ø®Ø²Ù† Ù¾Ø§ÛŒØ±ÙˆØ¨Ù„Ù‡ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯!*

           ```[ØªØºÛŒÛŒØ±Ø§Øª Ø¯Ø± ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ]
          {files_text}
          ```
          ```[Ù¾ÛŒØ§Ù… Ú©Ø§Ù…ÛŒØª]
          {commit_msg}
          ```

          *Ù†Ø³Ø®Ù‡ ÙØ¹Ù„ÛŒ Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡:* {version}
          *pypi:* {pypi_status}

          [*ðŸ”— Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø± GitHub:*]({github_url})

          ðŸ†” @pyrobale"""
          
          bot_token = os.environ['BALE_BOT_TOKEN']
          chat_id = os.environ['BALE_CHAT_ID']
          
          url = f"https://tapi.bale.ai/bot{bot_token}/sendMessage"
          payload = {
              "chat_id": chat_id,
              "text": message,
              "parse_mode": "Markdown"
          }
          
          response = requests.post(url, json=payload)
          if response.status_code == 200:
              print("âœ… Ù¾ÛŒØ§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯")
          else:
              print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾ÛŒØ§Ù…: {response.status_code}")
              print(response.text)
          EOF
        env:
          BALE_BOT_TOKEN: ${{ secrets.BALE_BOT_TOKEN }}
          BALE_CHAT_ID: ${{ secrets.BALE_CHAT_ID }}