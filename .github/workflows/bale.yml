name: Send Bale Notification on Commit
on:
  push:
    branches: [ main, master ]

jobs:
  send-bale-notification:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Get info and send to Bale
        run: |
          python3 << 'EOF'
          import requests
          import subprocess
          import re
          import os
          
          try:
              result = subprocess.run(
                  ['git', 'diff', '--name-only', os.environ['GITHUB_SHA'] + '~1', os.environ['GITHUB_SHA']],
                  capture_output=True, text=True, check=True
              )
              changed_files = [f for f in result.stdout.strip().split('\n') if f]
          except:
              changed_files = ["خطا در دریافت تغییرات"]
          
          version = "نامشخص"
          stable = False
          
          try:
              with open('version.py', 'r') as f:
                  content = f.read()
              
              version_match = re.search(r'version\s*=\s*["\']([^"\']+)["\']', content)
              stable_match = re.search(r'stable\s*=\s*(True|False)', content)
              
              version = version_match.group(1) if version_match else "نامشخص"
              stable = stable_match.group(1) == "True" if stable_match else False
          except Exception as e:
              print(f"Error reading version.py: {e}")
          
          try:
              commit_msg = subprocess.run(
                  ['git', 'log', '--format=%B', '-n', '1', os.environ['GITHUB_SHA']],
                  capture_output=True, text=True, check=True
              ).stdout.strip()
          except:
              commit_msg = "خطا در دریافت پیام کامیت"
          
          files_text = "\n".join([f"• {file}" for file in changed_files]) if changed_files else "بدون تغییرات فایل"
          pypi_status = "در pypi منتشر شد!" if stable else "این نسخه هنوز در pypi منشر نشده."
          github_url = f"{os.environ['GITHUB_SERVER_URL']}/{os.environ['GITHUB_REPOSITORY']}/commit/{os.environ['GITHUB_SHA']}"
          
          message = f"""🎉 *تغییرات جدیدی در مخزن پایروبله ایجاد شد!*

           ```[تغییرات در فایل‌های]
          {files_text}
          ```
          ```[پیام کامیت]
          {commit_msg}
          ```

          *نسخه فعلی کتابخانه:* {version}
          *pypi:* {pypi_status}

          [*🔗 مشاهده در GitHub*]({github_url})

          🆔 @pyrobale"""
          
          bot_token = os.environ['BALE_BOT_TOKEN']
          chat_id = os.environ['BALE_CHAT_ID']
          
          url = f"https://tapi.bale.ai/bot{bot_token}/sendMessage"
          payload = {
              "chat_id": chat_id,
              "text": message,
              "parse_mode": "Markdown"
          }
          
          response = requests.post(url, json=payload)
          if response.status_code == 200:
              print("✅ پیام با موفقیت ارسال شد")
          else:
              print(f"❌ خطا در ارسال پیام: {response.status_code}")
              print(response.text)
          EOF
        env:
          BALE_BOT_TOKEN: ${{ secrets.BALE_BOT_TOKEN }}
          BALE_CHAT_ID: ${{ secrets.BALE_CHAT_ID }}